# ==========================
# List of services
# ==========================
SERVICES=auth-service gateway-service product-service order-service file-service payment-service

# ==========================
# Individual Service Targets (Rebuild & Restart)
# ==========================
.PHONY: auth-service gateway-service product-service order-service file-service payment-service
auth-service gateway-service product-service order-service file-service payment-service:
	@echo "üîÑ Rebuilding $@..."
	cd $@ && make build
	@echo "üê≥ Rebuilding Docker image for $@..."
	docker compose up -d --build --no-deps $@

# ==========================
# Default target
# ==========================
.PHONY: all
all: build up

# ==========================
# 1Ô∏è‚É£ Build JARs for all services using their own Makefiles
# ==========================
.PHONY: build
build:
	@echo "üî® Building all Spring Boot services..."
	@for service in $(SERVICES); do \
		echo "‚û° Building $$service..."; \
		cd $$service && make build && cd ..; \
	done

# ==========================
# 2Ô∏è‚É£ Build Docker images for all services
# ==========================
.PHONY: docker-build
docker-build:
	@echo "üê≥ Building Docker images..."
	@for service in $(SERVICES); do \
		echo "‚û° Building image for $$service..."; \
		docker build -t ibrahimlboss/$$service:latest $$service; \
	done

# ==========================
# 3Ô∏è‚É£ Start Docker Compose stack
# ==========================
.PHONY: up
up:
	@echo "üöÄ Starting Docker Compose..."
	docker compose up --build -d

# ==========================
# 4Ô∏è‚É£ Stop Docker Compose stack
# ==========================
.PHONY: down
down:
	@echo "üõë Stopping Docker Compose..."
	@echo "üõë Stopping Docker Compose..."
	docker compose down

# ==========================
# 5Ô∏è‚É£ Clean Data (Volumes) -- For Database Reset
# ==========================
.PHONY: clean-data
clean-data:
	@echo "üßπ Removing containers and VOLUMES..."
	docker compose down -v

# ==========================
# 5Ô∏è‚É£ Push Docker images to Docker Hub
# ==========================
.PHONY: docker-push
docker-push:
	@echo "üì§ Pushing Docker images..."
	@for service in $(SERVICES); do \
		echo "‚û° Pushing image for $$service..."; \
		docker push ibrahimlboss/$$service:latest; \
	done
